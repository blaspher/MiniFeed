<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>MiniFeed 后端验证页</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
    h2 { margin-bottom: 8px; }
    h3 { margin: 20px 0 8px; }
    input, textarea { padding: 6px; margin: 4px 8px 4px 0; width: 260px; }
    textarea { width: 400px; height: 60px; }
    button { padding: 6px 14px; margin: 4px 0; cursor: pointer; }
    pre { padding: 10px; background: #f3f3f3; border-radius: 4px; min-height: 80px; white-space: pre-wrap; word-break: break-all; }
    hr { margin: 20px 0; }
    #posts { margin-top: 8px; }
    #posts div { border-bottom: 1px solid #ddd; padding: 6px 0; }
    .small { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h2>MiniFeed 后端验证页</h2>

  <h3>Token</h3>
  <input id="token" placeholder="登录后自动填充 Token" />

  <hr>

  <h3>注册 /user/register</h3>
  <input id="reg_u" placeholder="用户名">
  <input id="reg_p" placeholder="密码" type="password">
  <button onclick="register()">注册</button>

  <h3>登录 /user/login</h3>
  <input id="login_u" placeholder="用户名">
  <input id="login_p" placeholder="密码" type="password">
  <button onclick="login()">登录</button>

  <h3>/api/me</h3>
  <button onclick="getMe()">获取当前用户</button>

  <h3>搜索用户 /api/users/search</h3>
  <input id="keyword" placeholder="keyword">
  <button onclick="searchUsers()">搜索</button>

  <hr>

  <h3>发帖 /api/post</h3>
  <textarea id="post_content" placeholder="说点什么..."></textarea><br>
  <input id="post_image" placeholder="图片 URL（可空）">
  <button onclick="createPost()">发布</button>

  <h3>公共列表 /posts（cursor）</h3>
  <input id="posts_cursor" placeholder="cursor">
  <button onclick="loadPosts()">加载 /posts</button>
  <div id="posts"></div>

  <h3>点赞 /api/post/:id/like</h3>
  <input id="like_id" placeholder="post_id">
  <button onclick="likeById()">点赞/取消点赞</button>

  <hr>

  <h3>关注 / 取关</h3>
  <input id="follow_id" placeholder="关注的用户 ID">
  <button onclick="follow()">关注</button><br>
  <input id="unfollow_id" placeholder="取关的用户 ID">
  <button onclick="unfollow()">取关</button>

  <h3>关注列表 /api/following</h3>
  <button onclick="getFollowing()">获取</button>

  <h3>粉丝列表 /api/followers</h3>
  <button onclick="getFollowers()">获取</button>

  <hr>

  <h3>拉模式 Feed /api/feed/pull（cursor）</h3>
  <input id="pull_cursor" placeholder="cursor">
  <button onclick="getPull()">获取拉模式</button>

  <h3>推模式 Feed /api/feed/push（cursor=score）</h3>
  <input id="push_cursor" placeholder="cursor（score）">
  <button onclick="getPush()">获取推模式</button>

  <hr>
  <h3>返回结果</h3>
  <pre id="out"></pre>

<script>
const BASE = "http://localhost:8888";

function show(data) {
  document.getElementById("out").textContent = JSON.stringify(data, null, 2);
}
function token() { return document.getElementById("token").value.trim(); }

async function register() {
  const res = await fetch(BASE + "/user/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: reg_u.value.trim(), password: reg_p.value })
  });
  show(await res.json());
}

async function login() {
  const res = await fetch(BASE + "/user/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: login_u.value.trim(), password: login_p.value })
  });
  const data = await res.json();
  show(data);
  if (data.data && data.data.token) tokenInput.value = data.data.token;
}

const tokenInput = document.getElementById("token");
tokenInput.value = token();

async function authedGet(url) {
  const res = await fetch(BASE + url, { headers: { Authorization: "Bearer " + token() }});
  return res.json();
}
async function authedPost(url, body) {
  const res = await fetch(BASE + url, {
    method: "POST",
    headers: { Authorization: "Bearer " + token(), "Content-Type": "application/json" },
    body: JSON.stringify(body || {})
  });
  return res.json();
}

async function getMe() { show(await authedGet("/api/me")); }
async function searchUsers() { show(await authedGet("/api/users/search?keyword=" + encodeURIComponent(keyword.value.trim()))); }
async function createPost() {
  if (!post_content.value.trim()) return show({ error: "内容不能为空" });
  show(await authedPost("/api/post", { content: post_content.value.trim(), image_url: post_image.value.trim() }));
}
async function loadPosts() {
  let url = "/posts?limit=10";
  if (posts_cursor.value.trim()) url += "&cursor=" + encodeURIComponent(posts_cursor.value.trim());
  const res = await fetch(BASE + url);
  const data = await res.json();
  show(data);
  const list = (data.data && data.data.list) ? data.data.list : (data.list || []);
  renderPosts(list);
  const next = data.data && data.data.next_cursor !== undefined ? data.data.next_cursor : data.next_cursor;
  if (next) posts_cursor.value = next;
}
function renderPosts(list) {
  const c = document.getElementById("posts");
  c.innerHTML = "";
  if (!list || !list.length) { c.textContent = "暂无动态"; return; }
  list.forEach(p => {
    const d = document.createElement("div");
    d.innerHTML = `
      <div>Post #${p.id} 用户:${p.user_id}</div>
      <div>${p.content || ""}</div>
      ${p.image_url ? `<div class="small">图片: ${p.image_url}</div>` : ""}
      <div class="small">like_count: ${p.like_count || 0}</div>
      <button>点赞/取消点赞</button>
    `;
    d.querySelector("button").onclick = async () => {
      show(await authedPost(`/api/post/${p.id}/like`, {}));
      loadPosts();
    };
    c.appendChild(d);
  });
}
async function likeById() { show(await authedPost(`/api/post/${like_id.value.trim()}/like`, {})); }
async function follow() { show(await authedPost(`/api/follow/${follow_id.value.trim()}`, {})); }
async function unfollow() { show(await authedPost(`/api/unfollow/${unfollow_id.value.trim()}`, {})); }
async function getFollowing() { show(await authedGet("/api/following")); }
async function getFollowers() { show(await authedGet("/api/followers")); }
async function getPull() {
  let url = "/api/feed/pull?limit=10";
  if (pull_cursor.value.trim()) url += "&cursor=" + encodeURIComponent(pull_cursor.value.trim());
  show(await authedGet(url));
}
async function getPush() {
  let url = "/api/feed/push?limit=10";
  if (push_cursor.value.trim()) url += "&cursor=" + encodeURIComponent(push_cursor.value.trim());
  show(await authedGet(url));
}
</script>
</body>
</html>
